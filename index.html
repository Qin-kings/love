

<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>æƒ…ä¾£ç›¸å†Œ ğŸ’–</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-pink-100 min-h-screen flex flex-col items-center p-6">

  <h1 class="text-2xl font-bold mb-4">æƒ…ä¾£ç›¸å†Œ ğŸ’–</h1>

  <!-- Token è¾“å…¥æ¡† -->
  <input type="password" id="ghToken" placeholder="è¯·è¾“å…¥ GitHub Token" 
         class="mb-4 px-3 py-2 border rounded w-80">

  <!-- ä¸Šä¼ åŒº -->
  <input type="file" id="photoFiles" class="mb-4">
  <button onclick="startUpload()" class="px-4 py-2 bg-pink-400 text-white rounded-lg">ä¸Šä¼ </button>

  <!-- ç›¸å†Œå±•ç¤º -->
  <div id="gallery" class="grid grid-cols-2 gap-4 w-full mt-6"></div>

  <script>
    const GH_OWNER   = "Qin-kings";   // ä¿®æ”¹ä¸ºä½ çš„ GitHub ç”¨æˆ·å
    const GH_REPO    = "love_test";   // ä¿®æ”¹ä¸ºä½ çš„ä»“åº“å
    const GH_BRANCH  = "main";        // ä¿®æ”¹ä¸ºä½ çš„åˆ†æ”¯
    const GH_PATH    = "gallery.json";

    // Postimages é…ç½®
    const PI_KEY     = "ä½ çš„Postimages API Key";
    const PI_GALLERY = "ä½ çš„Gallery ID";

    // æ¸²æŸ“ç›¸å†Œï¼ˆä» GitHub API è¯»å–æœ€æ–°ï¼‰
    async function refreshGallery() {
      const res = await fetch(`https://api.github.com/repos/${GH_OWNER}/${GH_REPO}/contents/${GH_PATH}?ref=${GH_BRANCH}`);
      const j = await res.json();
      const content = atob(j.content);   // base64 è§£ç 
      const list = JSON.parse(content);

      const container = document.getElementById("gallery");
      container.innerHTML = "";
      list.slice().reverse().forEach(item => {
        const img = document.createElement("img");
        img.src = item.src;
        img.className = "w-full h-40 object-cover rounded-lg shadow";
        container.appendChild(img);
      });
    }

    // æ–‡ä»¶è½¬ base64
    function fileToBase64(file){
      return new Promise((resolve, reject)=>{
        const r = new FileReader();
        r.onload = ()=>resolve(r.result.split(",")[1]);
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }

    // ä¸Šä¼ åˆ° Postimages
    async function uploadToPostimages({base64, fileName}){
      const form = new URLSearchParams();
      form.set("key", PI_KEY);
      form.set("gallery", PI_GALLERY);
      form.set("name", fileName);
      form.set("type", fileName.split(".").pop());
      form.set("image", base64);

      const res = await fetch("https://api.postimage.org/1/upload", {
        method: "POST",
        headers: {"Content-Type": "application/x-www-form-urlencoded"},
        body: form.toString()
      });
      const data = await res.json();
      return data.url || data.image?.url || "";
    }

    // è¯» manifestï¼ˆGitHub APIï¼‰
    async function readManifestViaAPI(){
      const res = await fetch(`https://api.github.com/repos/${GH_OWNER}/${GH_REPO}/contents/${GH_PATH}?ref=${GH_BRANCH}`, {
        headers: {"Accept": "application/vnd.github+json"}
      });
      const j = await res.json();
      const content = atob(j.content);
      return {list: JSON.parse(content), sha: j.sha};
    }

    // å†™ manifestï¼ˆGitHub APIï¼‰
    async function writeManifestViaAPI({list, sha, message, token}){
      const body = {
        message: message,
        content: btoa(unescape(encodeURIComponent(JSON.stringify(list, null, 2)))),
        sha, branch: GH_BRANCH
      };
      const res = await fetch(`https://api.github.com/repos/${GH_OWNER}/${GH_REPO}/contents/${GH_PATH}`, {
        method: "PUT",
        headers: {
          "Accept": "application/vnd.github+json",
          "Authorization": `Bearer ${token}`
        },
        body: JSON.stringify(body)
      });
      if(!res.ok) throw new Error(await res.text());
    }

    // ä¸Šä¼ å…¥å£
    async function startUpload(){
      const token = document.getElementById("ghToken").value.trim();
      if(!token) return alert("è¯·å…ˆè¾“å…¥ GitHub Token");
      const files = document.getElementById("photoFiles").files;
      if(files.length === 0) return alert("è¯·é€‰æ‹©æ–‡ä»¶");

      const {list, sha} = await readManifestViaAPI();
      for(const f of files){
        const base64 = await fileToBase64(f);
        const url = await uploadToPostimages({base64, fileName: f.name});
        list.push({src: url, who:"æˆ‘ä»¬", ts: Date.now()});
      }
      await writeManifestViaAPI({list, sha, message: "add photo", token});
      alert("ä¸Šä¼ æˆåŠŸ âœ…");
      refreshGallery();
    }

    document.addEventListener("DOMContentLoaded", refreshGallery);
  </script>
</body>
</html>
